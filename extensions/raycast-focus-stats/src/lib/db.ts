import { environment } from "@raycast/api";
import { resolve } from "path";
import { arch } from "os";
import Database from "better-sqlite3-multiple-ciphers";
import { drizzle } from "drizzle-orm/better-sqlite3";

/*
 * Returns the path where the better-sqlite3 binding should be located. This is simply the node
 * version in used, inside the extension's support folder.
 */
export const SQLiteBindingFolder = (function () {
  return resolve(environment.supportPath, `v${process.versions.modules}`);
})();

/*
 * Returns the path where the better-sqlite3 binding should be located.
 */
export const SQLiteBindingPath = (function () {
  return resolve(SQLiteBindingFolder, `better-sqlite3-v${process.versions.modules}-${arch()}.node`);
})();

/*
 * Returns the path where the database migration files, generated by Drizzle, are kept.
 */
export const DatabaseMigrationsFolder = (function () {
  return resolve(environment.assetsPath, `drizzle`);
})();

export const DatabasePath = (function () {
  return resolve(environment.supportPath, `sessions.db`);
})();

/*
 * Returns a new database connection to the database used to save Raycast Focus session information.
 * If the SQLite database file does not yet exist, it'll be created.
 */
export function getDatabase() {
  const database = new Database(DatabasePath, {
    nativeBinding: SQLiteBindingPath,
  });

  return drizzle(database);
}
